name: Deploy SQL Script

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Deploy SQL Script
      env:
        SERVER: ${{ secrets.SQL_SERVER }}
        DATABASE: ${{ secrets.SQL_DATABASE }}
        USER: ${{ secrets.SQL_USER }}
        PASSWORD: ${{ secrets.SQL_PASSWORD }}
      run: |
        $sqlScriptPath = 'database/StoredProcedure/GetEmployees.sql'
        $sqlScript = Get-Content -Path $sqlScriptPath -Raw
        $connectionString = "Server=$env:SERVER;Database=$env:DATABASE;User Id=$env:USER;Password=$env:PASSWORD;"
        
        $connection = New-Object System.Data.SqlClient.SqlConnection
        $connection.ConnectionString = $connectionString
        $connection.Open()
        
        $command = $connection.CreateCommand()
        $command.CommandText = $sqlScript
        $command.ExecuteNonQuery()
        
        $connection.Close()

        Write-Host "SQL script executed successfully."
